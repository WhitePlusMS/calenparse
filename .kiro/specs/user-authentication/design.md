# è®¾è®¡æ–‡æ¡£ - è®¿é—®æ§åˆ¶ï¼ˆæ¼”ç¤ºç«™ç‚¹ï¼‰

## æ¦‚è¿°

æœ¬è®¾è®¡å®ç° CalenParse åº”ç”¨çš„åŒå±‚æƒé™æ¶æ„ï¼Œæ”¯æŒç®¡ç†å‘˜å®Œæ•´åŠŸèƒ½ä½¿ç”¨å’Œè®¿å®¢æç®€è¯•ç”¨ã€‚ç³»ç»Ÿé‡‡ç”¨å®Œå…¨éš”ç¦»çš„æ•°æ®è¡¨è®¾è®¡ï¼Œç¡®ä¿ç®¡ç†å‘˜ç”Ÿäº§æ•°æ®ä¸è®¿å®¢è¯•ç”¨æ•°æ®äº’ä¸å¹²æ‰°ã€‚

**æ ¸å¿ƒè®¾è®¡åŸåˆ™**ï¼š
- **ç®¡ç†å‘˜ä¼˜å…ˆ**ï¼šç¡®ä¿ç®¡ç†å‘˜ä½“éªŒä¸å—è®¿å®¢åŠŸèƒ½å½±å“
- **æ•°æ®å®Œå…¨éš”ç¦»**ï¼šè®¿å®¢å’Œç®¡ç†å‘˜ä½¿ç”¨ä¸åŒçš„æ•°æ®è¡¨
- **æç®€è¯•ç”¨**ï¼šè®¿å®¢ä»…ä½“éªŒ LLM åˆ›å»ºæ—¥ç¨‹çš„æ ¸å¿ƒåŠŸèƒ½
- **æˆæœ¬å¯æ§**ï¼šä¸¥æ ¼çš„é…é¢é™åˆ¶ï¼ˆ1 æ¬¡ LLM + 3 æ¡äº‹ä»¶ + 1 å¤©æ¸…é™¤ï¼‰
- **å®ç°ç®€å•**ï¼šå‰ç«¯é…é¢æ£€æŸ¥ + åç«¯ RLS ç­–ç•¥ + å®šæ—¶æ¸…ç†

## æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯åº”ç”¨ (Vue 3)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ è®¿å®¢æ¨¡å¼ UI   â”‚  â”‚ ç®¡ç†å‘˜æ¨¡å¼ UI â”‚  â”‚ ç›‘æ§é¡µé¢      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           useAuth (èº«ä»½ç®¡ç†)                         â”‚    â”‚
â”‚  â”‚  - æµè§ˆå™¨æŒ‡çº¹ç”Ÿæˆ (FingerprintJS)                    â”‚    â”‚
â”‚  â”‚  - ç®¡ç†å‘˜ç™»å½•/ç™»å‡º (Supabase Auth)                   â”‚    â”‚
â”‚  â”‚  - æƒé™åˆ‡æ¢é€»è¾‘                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚useVisitor    â”‚   â”‚useEvents     â”‚   â”‚useMonitoringâ”‚      â”‚
â”‚  â”‚Events        â”‚   â”‚(ç®¡ç†å‘˜)       â”‚   â”‚(ç®¡ç†å‘˜)      â”‚      â”‚
â”‚  â”‚(è®¿å®¢)         â”‚   â”‚              â”‚   â”‚             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Supabase Backend                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚visitor_      â”‚  â”‚events è¡¨      â”‚  â”‚Supabase Auth â”‚      â”‚
â”‚  â”‚sessions è¡¨   â”‚  â”‚(ç®¡ç†å‘˜æ•°æ®)    â”‚  â”‚(ç®¡ç†å‘˜è®¤è¯)   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚visitor_      â”‚                                           â”‚
â”‚  â”‚events è¡¨     â”‚                                           â”‚
â”‚  â”‚(è®¿å®¢æ•°æ®)     â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ RLS ç­–ç•¥ + å®šæ—¶æ¸…ç† (pg_cron)                     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

**è®¿å®¢æ¨¡å¼æµç¨‹**ï¼š
1. ç”¨æˆ·æ‰“å¼€åº”ç”¨ â†’ ç”Ÿæˆæµè§ˆå™¨æŒ‡çº¹ (FingerprintJS)
2. æŸ¥è¯¢/åˆ›å»º visitor_sessions è®°å½•
3. ä» visitor_events è¡¨åŠ è½½è¯¥æŒ‡çº¹çš„äº‹ä»¶
4. åˆ›å»ºäº‹ä»¶å‰æ£€æŸ¥é…é¢ï¼ˆCOUNT æŸ¥è¯¢ visitor_eventsï¼‰
5. è°ƒç”¨ LLM å‰æ£€æŸ¥é…é¢ï¼ˆvisitor_sessions.llm_used_countï¼‰

**ç®¡ç†å‘˜æ¨¡å¼æµç¨‹**ï¼š
1. ç”¨æˆ·ç‚¹å‡»ç™»å½• â†’ è¾“å…¥é‚®ç®±å¯†ç 
2. Supabase Auth éªŒè¯å‡­è¯ â†’ åˆ›å»ºä¼šè¯
3. ä» events è¡¨åŠ è½½æ‰€æœ‰äº‹ä»¶
4. æ‰€æœ‰æ“ä½œæ— é…é¢é™åˆ¶

**æƒé™åˆ‡æ¢æµç¨‹**ï¼š
1. åº”ç”¨å¯åŠ¨ â†’ æ£€æŸ¥ Supabase Auth ä¼šè¯
2. æœ‰æ•ˆä¼šè¯ â†’ ç®¡ç†å‘˜æ¨¡å¼
3. æ— ä¼šè¯ â†’ è®¿å®¢æ¨¡å¼ï¼ˆç”ŸæˆæŒ‡çº¹ï¼‰
4. ç™»å½•/ç™»å‡ºè§¦å‘æ¨¡å¼åˆ‡æ¢ â†’ æ¸…ç©ºæ—§æ•°æ® â†’ åŠ è½½æ–°æ•°æ®

## ç»„ä»¶å’Œæ¥å£

### æ ¸å¿ƒ Composables

#### 1. useAuth (èº«ä»½ç®¡ç†)

```typescript
interface UseAuthReturn {
  // çŠ¶æ€
  mode: Ref<'visitor' | 'admin'>
  fingerprint: Ref<string | null>
  adminSession: Ref<Session | null>
  isAdmin: ComputedRef<boolean>
  isAuthChecking: Ref<boolean>  // ğŸ”¥ é˜²æ­¢ç«æ€æ¡ä»¶ï¼šåº”ç”¨å¯åŠ¨æ—¶çš„èº«ä»½æ£€æŸ¥çŠ¶æ€
  
  // è®¿å®¢ç›¸å…³
  initVisitorMode: () => Promise<void>
  getVisitorQuota: () => Promise<VisitorQuota>
  
  // ç®¡ç†å‘˜ç›¸å…³
  login: (email: string, password: string) => Promise<void>
  logout: () => Promise<void>
  
  // æƒé™åˆ‡æ¢
  switchMode: (newMode: 'visitor' | 'admin') => Promise<void>
}

/**
 * ğŸ”¥ ç«æ€æ¡ä»¶å¤„ç†è¯´æ˜
 * 
 * é—®é¢˜ï¼šåº”ç”¨å¯åŠ¨æ—¶ï¼ŒSupabase Auth æ£€æŸ¥ä¼šè¯æ˜¯å¼‚æ­¥çš„ï¼ˆçº¦ 500msï¼‰
 * - åˆå§‹çŠ¶æ€ï¼šadminSession = null â†’ ç³»ç»Ÿåˆ¤å®šä¸ºè®¿å®¢ â†’ ç”ŸæˆæŒ‡çº¹
 * - 500ms åï¼šSupabase è¿”å› Session â†’ ç³»ç»Ÿåˆ‡æ¢ä¸ºç®¡ç†å‘˜
 * 
 * åæœï¼šç®¡ç†å‘˜ä¼šçœ‹åˆ°çŸ­æš‚çš„"è®¿å®¢æ¨ªå¹…"é—ªçƒï¼Œä½“éªŒä¸ä½³
 * 
 * è§£å†³æ–¹æ¡ˆï¼š
 * 1. useAuth åˆå§‹åŒ–æ—¶è®¾ç½® isAuthChecking = true
 * 2. App.vue æ£€æµ‹åˆ° isAuthChecking = true æ—¶ï¼Œæ˜¾ç¤ºå…¨å± Loading
 * 3. ä¸æ¸²æŸ“ä»»ä½•ä¸šåŠ¡ç»„ä»¶ï¼ˆè®¿å®¢æ¨ªå¹…ã€äº‹ä»¶åˆ—è¡¨ç­‰ï¼‰
 * 4. èº«ä»½ç¡®å®šåï¼ˆç®¡ç†å‘˜æˆ–è®¿å®¢ï¼‰ï¼Œè®¾ç½® isAuthChecking = false
 * 5. æ¸²æŸ“å¯¹åº”æ¨¡å¼çš„ UI
 * 
 * å®ç°ç¤ºä¾‹ï¼š
 * ```vue
 * <template>
 *   <div v-if="isAuthChecking" class="auth-loading">
 *     <el-icon class="is-loading"><Loading /></el-icon>
 *     <p>æ­£åœ¨åŠ è½½...</p>
 *   </div>
 *   <div v-else>
 *     <!-- ä¸šåŠ¡ç»„ä»¶ -->
 *   </div>
 * </template>
 * ```
 */

interface VisitorQuota {
  llmRemaining: number      // 0 æˆ– 1
  eventsUsed: number        // 0-3
  eventsRemaining: number   // 3 - eventsUsed
}
```

**èŒè´£**ï¼š
- ç”Ÿæˆå’Œç®¡ç†æµè§ˆå™¨æŒ‡çº¹
- ç®¡ç†å‘˜ç™»å½•/ç™»å‡ºï¼ˆSupabase Authï¼‰
- ç»´æŠ¤å½“å‰ç”¨æˆ·èº«ä»½çŠ¶æ€
- æä¾›é…é¢æŸ¥è¯¢æ¥å£
- **é˜²æ­¢ç«æ€æ¡ä»¶**ï¼šé€šè¿‡ `isAuthChecking` çŠ¶æ€é¿å…åº”ç”¨å¯åŠ¨æ—¶çš„èº«ä»½æ£€æŸ¥é—ªçƒ

#### 2. useVisitorEvents (è®¿å®¢äº‹ä»¶ç®¡ç†)

```typescript
interface UseVisitorEventsReturn {
  // çŠ¶æ€
  events: Ref<VisitorEvent[]>
  loading: Ref<boolean>
  
  // æ–¹æ³•
  loadEvents: (fingerprint: string) => Promise<void>
  createEvent: (event: Omit<VisitorEvent, 'id' | 'created_at'>) => Promise<void>
  checkEventQuota: (fingerprint: string) => Promise<boolean>
  
  // LLM ç›¸å…³
  callLLM: (input: string, fingerprint: string) => Promise<LLMResult>
  checkLLMQuota: (fingerprint: string) => Promise<boolean>
  recordLLMUsage: (fingerprint: string, tokenUsed: number) => Promise<void>
}

interface VisitorEvent {
  id: string
  fingerprint: string
  title: string
  start_time: string      // ğŸ”¥ ISO-8601 UTC æ ¼å¼ (YYYY-MM-DDTHH:mm:ss.sssZ)
  end_time: string        // ğŸ”¥ ISO-8601 UTC æ ¼å¼ (YYYY-MM-DDTHH:mm:ss.sssZ)
  is_all_day: boolean
  location?: string
  description?: string
  original_text?: string
  created_at: string
}

/**
 * ğŸ”¥ æ—¶åŒºå¤„ç†è§„èŒƒ
 * 
 * é—®é¢˜ï¼šè®¿å®¢æ˜¯åŒ¿åçš„ï¼Œæ— æ³•å­˜å‚¨æ—¶åŒºåå¥½è®¾ç½®
 * 
 * è§£å†³æ–¹æ¡ˆï¼šç»Ÿä¸€ä½¿ç”¨ UTC æ—¶é—´
 * 1. å‰ç«¯å‘é€ï¼šæ‰€æœ‰æ—¶é—´å­—æ®µä½¿ç”¨ ISO-8601 UTC æ ¼å¼
 *    - ç¤ºä¾‹ï¼š'2024-01-15T14:30:00.000Z'
 *    - ä½¿ç”¨ Day.js: dayjs(date).utc().toISOString()
 * 
 * 2. æ•°æ®åº“å­˜å‚¨ï¼šTIMESTAMPTZ è‡ªåŠ¨å¤„ç†æ—¶åŒºè½¬æ¢
 *    - PostgreSQL å†…éƒ¨ä»¥ UTC å­˜å‚¨
 *    - æŸ¥è¯¢æ—¶è‡ªåŠ¨è½¬æ¢ä¸ºå®¢æˆ·ç«¯æ—¶åŒº
 * 
 * 3. å‰ç«¯æ˜¾ç¤ºï¼šæ ¹æ®æµè§ˆå™¨æ—¶åŒºæ˜¾ç¤º
 *    - ä½¿ç”¨ Day.js: dayjs(utcString).local().format('YYYY-MM-DD HH:mm')
 *    - æˆ–ä½¿ç”¨æµè§ˆå™¨ API: new Date(utcString).toLocaleString()
 * 
 * 4. å¯é€‰å¢å¼ºï¼ˆPhase 3ï¼‰ï¼š
 *    - åœ¨ visitor_sessions è¡¨æ·»åŠ  timezone å­—æ®µ
 *    - å­˜å‚¨æµè§ˆå™¨æ—¶åŒºï¼šIntl.DateTimeFormat().resolvedOptions().timeZone
 *    - ç”¨äºç›‘æ§é¡µé¢æ˜¾ç¤ºè®¿å®¢æ‰€åœ¨æ—¶åŒº
 */
```

**èŒè´£**ï¼š
- è®¿å®¢äº‹ä»¶çš„ CRUDï¼ˆä»… Create + Readï¼‰
- é…é¢æ£€æŸ¥ï¼ˆäº‹ä»¶æ•°é‡ + LLM è°ƒç”¨ï¼‰
- LLM è°ƒç”¨å’Œ Token è¿½è¸ª
- ä¸ visitor_sessions å’Œ visitor_events è¡¨äº¤äº’

#### 3. useMonitoring (ç®¡ç†å‘˜ç›‘æ§)

```typescript
interface UseMonitoringReturn {
  // çŠ¶æ€
  sessions: Ref<VisitorSession[]>
  statistics: Ref<VisitorStatistics>
  selectedSession: Ref<VisitorSession | null>
  sessionEvents: Ref<VisitorEvent[]>
  loading: Ref<boolean>
  
  // æ–¹æ³•
  loadSessions: () => Promise<void>
  loadSessionEvents: (fingerprint: string) => Promise<void>
  refreshData: () => Promise<void>
}

interface VisitorSession {
  fingerprint: string
  llm_used_count: number
  llm_token_used: number
  event_count: number  // é€šè¿‡ JOIN è®¡ç®—
  created_at: string
  last_active_at: string
}

interface VisitorStatistics {
  totalVisitors: number
  totalLLMCalls: number
  totalTokens: number
  totalEvents: number
  lastCleanupTime: string | null
}
```

**èŒè´£**ï¼š
- æŸ¥è¯¢æ‰€æœ‰è®¿å®¢ä¼šè¯
- æŸ¥è¯¢ç‰¹å®šè®¿å®¢çš„äº‹ä»¶è¯¦æƒ…
- è®¡ç®—ç»Ÿè®¡æ•°æ®
- ä»…ç®¡ç†å‘˜å¯è®¿é—®

### UI ç»„ä»¶

#### 1. VisitorBanner.vue (è®¿å®¢æ¨ªå¹…)

```vue
<script setup lang="ts">
interface Props {
  quota: VisitorQuota
}

const emit = defineEmits<{
  login: []
}>()
</script>
```

**åŠŸèƒ½**ï¼š
- æ˜¾ç¤ºå‰©ä½™é…é¢ï¼ˆLLM æ¬¡æ•° + äº‹ä»¶æ•°é‡ï¼‰
- æä¾›ç®¡ç†å‘˜ç™»å½•å…¥å£
- ä»…åœ¨è®¿å®¢æ¨¡å¼æ˜¾ç¤º

#### 2. AdminLoginDialog.vue (ç®¡ç†å‘˜ç™»å½•å¯¹è¯æ¡†)

```vue
<script setup lang="ts">
interface Props {
  visible: boolean
}

const emit = defineEmits<{
  close: []
  success: []
}>()
</script>
```

**åŠŸèƒ½**ï¼š
- é‚®ç®±å¯†ç è¾“å…¥è¡¨å•
- è°ƒç”¨ useAuth.login()
- é”™è¯¯æç¤º

#### 3. MonitoringPage.vue (ç›‘æ§é¡µé¢)

```vue
<script setup lang="ts">
// ç®¡ç†å‘˜ä¸“ç”¨é¡µé¢
</script>
```

**åŠŸèƒ½**ï¼š
- è®¿å®¢ä¼šè¯åˆ—è¡¨ï¼ˆè¡¨æ ¼ï¼‰
- ç»Ÿè®¡æ•°æ®å¡ç‰‡
- è®¿å®¢äº‹ä»¶è¯¦æƒ…ï¼ˆç‚¹å‡»å±•å¼€ï¼‰
- åˆ·æ–°æŒ‰é’®
- æƒé™ä¿æŠ¤ï¼ˆéç®¡ç†å‘˜é‡å®šå‘ï¼‰

### ä¿®æ”¹ç°æœ‰ç»„ä»¶

#### useEvents.ts (ç°æœ‰)

```typescript
// æ·»åŠ èº«ä»½æ£€æŸ¥é€»è¾‘
export function useEvents() {
  const { mode, fingerprint } = useAuth()
  const visitorEvents = useVisitorEvents()
  
  // æ ¹æ® mode è·¯ç”±åˆ°ä¸åŒçš„æ•°æ®æº
  const loadEvents = async () => {
    if (mode.value === 'admin') {
      // ç°æœ‰é€»è¾‘ï¼šä» events è¡¨åŠ è½½
      await loadAdminEvents()
    } else {
      // æ–°é€»è¾‘ï¼šä» visitor_events è¡¨åŠ è½½
      await visitorEvents.loadEvents(fingerprint.value!)
    }
  }
  
  // å…¶ä»–æ–¹æ³•ç±»ä¼¼å¤„ç†
}
```

## æ•°æ®æ¨¡å‹

### æ•°æ®åº“è¡¨ç»“æ„

#### visitor_sessions (è®¿å®¢ä¼šè¯è¡¨)

```sql
CREATE TABLE visitor_sessions (
  fingerprint TEXT PRIMARY KEY,
  llm_used_count INT DEFAULT 0 CHECK (llm_used_count IN (0, 1)),
  llm_token_used INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_active_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_visitor_sessions_created_at ON visitor_sessions(created_at);
CREATE INDEX idx_visitor_sessions_last_active ON visitor_sessions(last_active_at);
```

**å­—æ®µè¯´æ˜**ï¼š
- `fingerprint`: æµè§ˆå™¨æŒ‡çº¹ï¼ˆä¸»é”®ï¼‰
- `llm_used_count`: LLM è°ƒç”¨æ¬¡æ•°ï¼ˆ0 æˆ– 1ï¼‰
- `llm_token_used`: ç´¯è®¡ Token æ¶ˆè€—
- `created_at`: åˆ›å»ºæ—¶é—´ï¼ˆç”¨äºå®šæ—¶æ¸…ç†ï¼‰
- `last_active_at`: æœ€åæ´»è·ƒæ—¶é—´

**è®¾è®¡å†³ç­–**ï¼š
- ç§»é™¤ `event_count` å­—æ®µï¼Œé€šè¿‡ `COUNT(*)` æŸ¥è¯¢ visitor_events è¡¨è®¡ç®—
- é¿å…æ•°æ®ä¸ä¸€è‡´é£é™©ï¼ˆevent_count å¯èƒ½ä¸å®é™…äº‹ä»¶æ•°ä¸åŒæ­¥ï¼‰
- æ€§èƒ½å¼€é”€å¯å¿½ç•¥ï¼ˆæ¯ä¸ªè®¿å®¢æœ€å¤š 3 æ¡äº‹ä»¶ï¼‰

#### visitor_events (è®¿å®¢äº‹ä»¶è¡¨)

```sql
CREATE TABLE visitor_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  fingerprint TEXT NOT NULL REFERENCES visitor_sessions(fingerprint) ON DELETE CASCADE,
  title TEXT NOT NULL,
  start_time TIMESTAMPTZ NOT NULL,  -- ğŸ”¥ å­˜å‚¨ UTC æ—¶é—´ï¼Œå‰ç«¯å‘é€ ISO-8601 æ ¼å¼
  end_time TIMESTAMPTZ NOT NULL,    -- ğŸ”¥ å­˜å‚¨ UTC æ—¶é—´ï¼Œå‰ç«¯å‘é€ ISO-8601 æ ¼å¼
  is_all_day BOOLEAN DEFAULT false,
  location TEXT,
  description TEXT,
  original_text TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_visitor_events_fingerprint ON visitor_events(fingerprint);
CREATE INDEX idx_visitor_events_start_time ON visitor_events(start_time);
CREATE INDEX idx_visitor_events_created_at ON visitor_events(created_at);
```

**å­—æ®µè¯´æ˜**ï¼š
- `id`: UUID ä¸»é”®
- `fingerprint`: å¤–é”®å…³è” visitor_sessionsï¼ˆçº§è”åˆ é™¤ï¼‰
- `title`, `start_time`, `end_time`: äº‹ä»¶æ ¸å¿ƒå­—æ®µ
- `is_all_day`: å…¨å¤©äº‹ä»¶æ ‡å¿—
- `location`, `description`, `original_text`: å¯é€‰å­—æ®µ
- `created_at`: åˆ›å»ºæ—¶é—´

**ä¸ç®¡ç†å‘˜ events è¡¨çš„å·®å¼‚**ï¼š
- æ—  `tag_ids` å­—æ®µï¼ˆè®¿å®¢ä¸æ”¯æŒæ ‡ç­¾ï¼‰
- æ—  `color` å­—æ®µï¼ˆè®¿å®¢ä¸æ”¯æŒè‡ªå®šä¹‰é¢œè‰²ï¼‰
- æ—  `notes` å­—æ®µï¼ˆç®€åŒ–ç‰ˆï¼‰
- æ—  `updated_at` å­—æ®µï¼ˆè®¿å®¢ä¸èƒ½ç¼–è¾‘ï¼‰

**ğŸ”¥ æ—¶åŒºå¤„ç†è§„èŒƒ**ï¼š
- ä½¿ç”¨ `TIMESTAMPTZ` è€Œé `TIMESTAMP` ä»¥æ”¯æŒæ—¶åŒº
- å‰ç«¯å¿…é¡»å‘é€ ISO-8601 UTC æ ¼å¼ï¼š`2024-01-15T14:30:00.000Z`
- PostgreSQL è‡ªåŠ¨å¤„ç†æ—¶åŒºè½¬æ¢å’Œå­˜å‚¨
- å‰ç«¯æ˜¾ç¤ºæ—¶æ ¹æ®æµè§ˆå™¨æ—¶åŒºæœ¬åœ°åŒ–ï¼ˆä½¿ç”¨ Day.jsï¼‰

#### events (ç®¡ç†å‘˜äº‹ä»¶è¡¨ - ç°æœ‰)

**æ— éœ€ä¿®æ”¹**ï¼Œä¿æŒç°æœ‰ç»“æ„ã€‚

### RLS ç­–ç•¥è®¾è®¡

#### visitor_sessions è¡¨

```sql
-- å…è®¸æ‰€æœ‰äººæŸ¥è¯¢å’Œæ’å…¥ï¼ˆç”¨äºæŒ‡çº¹åˆå§‹åŒ–ï¼‰
CREATE POLICY "Allow public read access" ON visitor_sessions
  FOR SELECT USING (true);

CREATE POLICY "Allow public insert" ON visitor_sessions
  FOR INSERT WITH CHECK (true);

-- å…è®¸æ›´æ–°ï¼ˆç”¨äºé…é¢é€’å¢ï¼‰
CREATE POLICY "Allow public update" ON visitor_sessions
  FOR UPDATE USING (true);

-- ç¦æ­¢åˆ é™¤ï¼ˆä»…å®šæ—¶ä»»åŠ¡åˆ é™¤ï¼‰
CREATE POLICY "Prevent public delete" ON visitor_sessions
  FOR DELETE USING (false);
```

**è®¾è®¡å†³ç­–**ï¼š
- å®½æ¾çš„è¯»å†™ç­–ç•¥ï¼Œä¾èµ–å‰ç«¯ fingerprint è¿‡æ»¤
- è®¿å®¢ç†è®ºä¸Šå¯ä»¥æŸ¥çœ‹å…¶ä»–è®¿å®¢æ•°æ®ï¼Œä½†é£é™©å¯æ§ï¼š
  - æ•°æ® 1 å¤©åè‡ªåŠ¨åˆ é™¤
  - æ— æ•æ„Ÿä¿¡æ¯
  - å®ç°ä¸¥æ ¼ RLS éœ€è¦å¤æ‚çš„ session å˜é‡ç®¡ç†
- ç¦æ­¢åˆ é™¤ï¼Œé˜²æ­¢æ¶æ„æ¸…ç©ºæ•°æ®

#### visitor_events è¡¨

```sql
-- å…è®¸æ‰€æœ‰äººæŸ¥è¯¢ï¼ˆå‰ç«¯é€šè¿‡ fingerprint è¿‡æ»¤ï¼‰
CREATE POLICY "Allow public read access" ON visitor_events
  FOR SELECT USING (true);

-- ğŸ”¥ å…è®¸æ’å…¥ï¼ˆæ•°æ®åº“å±‚é¢é…é¢æ£€æŸ¥ï¼Œé˜²æ­¢æ¶æ„ç»•è¿‡å‰ç«¯ï¼‰
CREATE POLICY "Allow public insert with quota check" ON visitor_events
  FOR INSERT WITH CHECK (
    (SELECT COUNT(*) FROM visitor_events WHERE fingerprint = visitor_events.fingerprint) < 3
  );

-- ç¦æ­¢æ›´æ–°å’Œåˆ é™¤
CREATE POLICY "Prevent public update" ON visitor_events
  FOR UPDATE USING (false);

CREATE POLICY "Prevent public delete" ON visitor_events
  FOR DELETE USING (false);
```

**è®¾è®¡å†³ç­–**ï¼š
- ç¦æ­¢æ›´æ–°å’Œåˆ é™¤ï¼Œç¡®ä¿è®¿å®¢åªèƒ½åˆ›å»º
- **ğŸ”¥ æ•°æ®åº“å±‚é¢é…é¢æ£€æŸ¥**ï¼šé˜²æ­¢æ¶æ„ç”¨æˆ·ç›´æ¥è°ƒç”¨ Supabase API ç»•è¿‡å‰ç«¯æ£€æŸ¥
  - è™½ç„¶å‰ç«¯æœ‰é…é¢æ£€æŸ¥ï¼Œä½†æ‡‚æŠ€æœ¯çš„ç”¨æˆ·å¯ä»¥ç›´æ¥è°ƒç”¨ API
  - åœ¨ RLS ç­–ç•¥ä¸­æ·»åŠ  `COUNT(*)` æ£€æŸ¥ï¼Œç¡®ä¿æ¯ä¸ªæŒ‡çº¹æœ€å¤š 3 æ¡äº‹ä»¶
  - æ€§èƒ½å½±å“ï¼šè½»å¾®å¢åŠ æ’å…¥å¼€é”€ï¼ˆçº¦ 10-20msï¼‰ï¼Œä½†å¯¹ MVP ä½å¹¶å‘åœºæ™¯å®Œå…¨å¯æ¥å—
  - å®‰å…¨æ”¶ç›Šï¼šé˜²æ­¢æ¶æ„ç”¨æˆ·æ’å…¥ 10,000+ æ¡æ•°æ®æ¶ˆè€—æ•°æ®åº“ååé‡
- å‰ç«¯ä»éœ€é…é¢æ£€æŸ¥ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼ˆå³æ—¶åé¦ˆï¼‰

#### events è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰

```sql
-- ğŸ”’ ä»…å…è®¸å·²è®¤è¯ç”¨æˆ·è®¿é—®
CREATE POLICY "Allow only admin access" ON events
  AS PERMISSIVE FOR ALL
  TO authenticated
  USING (true)
  WITH CHECK (true);
```

**è®¾è®¡å†³ç­–**ï¼š
- ä¸¥æ ¼é™åˆ¶ï¼šä»… authenticated ç”¨æˆ·å¯è®¿é—®
- é˜²æ­¢æœªç™»å½•ç”¨æˆ·æˆ–æ‹¿åˆ° Anon Key çš„æ”»å‡»è€…è®¿é—®ç®¡ç†å‘˜æ•°æ®
- è¿™æ˜¯å…³é”®çš„å®‰å…¨ä¿®å¤

### å®šæ—¶æ¸…ç†æœºåˆ¶

```sql
-- æ¸…ç†å‡½æ•°
CREATE OR REPLACE FUNCTION cleanup_visitor_data()
RETURNS void AS $BODY$
DECLARE
  deleted_sessions INT;
BEGIN
  WITH deleted AS (
    DELETE FROM visitor_sessions
    WHERE created_at < NOW() - INTERVAL '1 day'
    RETURNING fingerprint
  )
  SELECT COUNT(*) INTO deleted_sessions FROM deleted;
  
  RAISE NOTICE 'Cleaned up % visitor sessions', deleted_sessions;
END;
$BODY$ LANGUAGE plpgsql;

-- å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨ 2 ç‚¹ï¼‰
SELECT cron.schedule(
  'cleanup-visitor-data',
  '0 2 * * *',
  'SELECT cleanup_visitor_data();'
);
```

**è®¾è®¡å†³ç­–**ï¼š
- ä½¿ç”¨ pg_cron æ‰©å±•ï¼ˆSupabase æ”¯æŒï¼‰
- åˆ é™¤ visitor_sessions æ—¶ï¼Œå¤–é”®çº§è”åˆ é™¤ visitor_events
- 1 å¤©æ¸…ç†å‘¨æœŸï¼Œæ§åˆ¶æ•°æ®åº“å­˜å‚¨æˆæœ¬

## æ­£ç¡®æ€§å±æ€§

åœ¨ç¼–å†™æ­£ç¡®æ€§å±æ€§ä¹‹å‰ï¼Œæˆ‘éœ€è¦å…ˆå®ŒæˆéªŒæ”¶æ ‡å‡†çš„å¯æµ‹è¯•æ€§åˆ†æã€‚


## æ­£ç¡®æ€§å±æ€§

*å±æ€§æ˜¯ä¸€ä¸ªç‰¹å¾æˆ–è¡Œä¸ºï¼Œåº”è¯¥åœ¨ç³»ç»Ÿçš„æ‰€æœ‰æœ‰æ•ˆæ‰§è¡Œä¸­ä¿æŒä¸ºçœŸâ€”â€”æœ¬è´¨ä¸Šæ˜¯å…³äºç³»ç»Ÿåº”è¯¥åšä»€ä¹ˆçš„æ­£å¼é™ˆè¿°ã€‚å±æ€§ä½œä¸ºäººç±»å¯è¯»è§„èŒƒå’Œæœºå™¨å¯éªŒè¯æ­£ç¡®æ€§ä¿è¯ä¹‹é—´çš„æ¡¥æ¢ã€‚*

### å±æ€§åæ€

åœ¨å®šä¹‰æ­£ç¡®æ€§å±æ€§ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦è¯†åˆ«å¹¶æ¶ˆé™¤å†—ä½™ï¼š

**è¯†åˆ«çš„å†—ä½™**ï¼š
- éœ€æ±‚ 1.6 å’Œ 2.1 é‡å¤ï¼ˆç‚¹å‡»ç™»å½•é“¾æ¥æ˜¾ç¤ºå¯¹è¯æ¡†ï¼‰
- éœ€æ±‚ 1.7 å’Œ 6.7 é‡å¤ï¼ˆè®¿å®¢åˆ·æ–°é¡µé¢æ¢å¤æŒ‡çº¹ï¼‰
- éœ€æ±‚ 5.6 å’Œ 6.6 é‡å¤ï¼ˆç®¡ç†å‘˜åˆ·æ–°é¡µé¢æ¢å¤ä¼šè¯ï¼‰
- éœ€æ±‚ 1.9 å’Œ 3.5 éƒ¨åˆ†é‡å¤ï¼ˆè®¿å®¢æ¨¡å¼ä¸‹éšè—ç¼–è¾‘åˆ é™¤åŠŸèƒ½ï¼‰

**åˆå¹¶ç­–ç•¥**ï¼š
- å°†é‡å¤çš„éœ€æ±‚åˆå¹¶ä¸ºå•ä¸€å±æ€§
- å°†ç›¸å…³çš„æƒé™æ§åˆ¶åˆå¹¶ä¸ºç»¼åˆå±æ€§

### æ ¸å¿ƒå±æ€§

#### Property 1: æŒ‡çº¹ç¨³å®šæ€§
*å¯¹äºä»»ä½•* æµè§ˆå™¨ç¯å¢ƒï¼Œåœ¨ç›¸åŒçš„æµè§ˆå™¨ä¼šè¯ä¸­å¤šæ¬¡ç”ŸæˆæŒ‡çº¹åº”è¯¥è¿”å›ç›¸åŒçš„å€¼
**éªŒè¯éœ€æ±‚: 1.2**

#### Property 2: è®¿å®¢ä¼šè¯åˆå§‹åŒ–
*å¯¹äºä»»ä½•* æµè§ˆå™¨æŒ‡çº¹ï¼Œç³»ç»Ÿåº”è¯¥èƒ½å¤Ÿåœ¨ visitor_sessions è¡¨ä¸­æŸ¥è¯¢æˆ–åˆ›å»ºå¯¹åº”çš„è®°å½•
**éªŒè¯éœ€æ±‚: 1.3**

#### Property 3: è®¿å®¢æ•°æ®éš”ç¦»
*å¯¹äºä»»ä½•* æµè§ˆå™¨æŒ‡çº¹ï¼Œä» visitor_events è¡¨åŠ è½½çš„äº‹ä»¶åº”è¯¥åªåŒ…å«è¯¥æŒ‡çº¹å…³è”çš„äº‹ä»¶
**éªŒè¯éœ€æ±‚: 1.4, 3.4**

#### Property 4: è®¿å®¢é…é¢æ˜¾ç¤º
*å¯¹äºä»»ä½•* è®¿å®¢ä¼šè¯ï¼Œç•Œé¢æ¨ªå¹…åº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„å‰©ä½™ LLM æ¬¡æ•°ï¼ˆ0 æˆ– 1ï¼‰å’Œäº‹ä»¶é…é¢ï¼ˆ0-3ï¼‰
**éªŒè¯éœ€æ±‚: 1.5, 4.10**

#### Property 5: è®¿å®¢ä¼šè¯æŒä¹…æ€§
*å¯¹äºä»»ä½•* è®¿å®¢ä¼šè¯ï¼Œåˆ·æ–°é¡µé¢ååº”è¯¥ä½¿ç”¨ç›¸åŒçš„æµè§ˆå™¨æŒ‡çº¹å¹¶æ¢å¤è¯¥æŒ‡çº¹çš„é…é¢å’Œäº‹ä»¶æ•°æ®
**éªŒè¯éœ€æ±‚: 1.7, 6.7**

#### Property 6: è®¿å®¢æƒé™é™åˆ¶
*å¯¹äºä»»ä½•* è®¿å®¢æ¨¡å¼çš„ç”¨æˆ·ï¼Œç³»ç»Ÿåº”è¯¥éšè—æˆ–ç¦ç”¨ç¼–è¾‘ã€åˆ é™¤ã€æ‰¹é‡æ“ä½œã€å¯¼å…¥å¯¼å‡ºã€æ ‡ç­¾ç®¡ç†åŠŸèƒ½
**éªŒè¯éœ€æ±‚: 1.9, 3.5**

#### Property 7: ç®¡ç†å‘˜è®¤è¯
*å¯¹äºä»»ä½•* æœ‰æ•ˆçš„ç®¡ç†å‘˜å‡­è¯ï¼ˆé‚®ç®±å’Œå¯†ç ï¼‰ï¼Œç³»ç»Ÿåº”è¯¥é€šè¿‡ Supabase Auth éªŒè¯å¹¶åˆ›å»ºä¼šè¯
**éªŒè¯éœ€æ±‚: 2.2, 2.4**

#### Property 8: ç™»å½•åæ¨¡å¼åˆ‡æ¢
*å¯¹äºä»»ä½•* æˆåŠŸçš„ç®¡ç†å‘˜ç™»å½•ï¼Œç³»ç»Ÿåº”è¯¥åˆ‡æ¢åˆ°ç®¡ç†å‘˜æ¨¡å¼å¹¶æ˜¾ç¤ºç™»å‡ºæŒ‰é’®
**éªŒè¯éœ€æ±‚: 2.5, 2.6**

#### Property 9: ç™»å‡ºæµç¨‹
*å¯¹äºä»»ä½•* ç®¡ç†å‘˜ç™»å‡ºæ“ä½œï¼Œç³»ç»Ÿåº”è¯¥æ¸…é™¤ Supabase Auth ä¼šè¯å¹¶è¿”å›è®¿å®¢æ¨¡å¼
**éªŒè¯éœ€æ±‚: 2.7**

#### Property 10: è®¿å®¢äº‹ä»¶é…é¢è®¡ç®—
*å¯¹äºä»»ä½•* æµè§ˆå™¨æŒ‡çº¹ï¼Œåˆ›å»ºäº‹ä»¶å‰åº”è¯¥é€šè¿‡ COUNT æŸ¥è¯¢ visitor_events è¡¨è®¡ç®—è¯¥æŒ‡çº¹çš„äº‹ä»¶æ•°é‡
**éªŒè¯éœ€æ±‚: 3.1**

#### Property 11: è®¿å®¢äº‹ä»¶åˆ›å»ºï¼ˆé…é¢å†…ï¼‰
*å¯¹äºä»»ä½•* äº‹ä»¶æ•°é‡å°äº 3 çš„è®¿å®¢ï¼Œç³»ç»Ÿåº”è¯¥å…è®¸åˆ›å»ºæ–°äº‹ä»¶å¹¶ä¿å­˜åˆ° visitor_events è¡¨
**éªŒè¯éœ€æ±‚: 3.2**

#### Property 12: è®¿å®¢ API æƒé™æ§åˆ¶
*å¯¹äºä»»ä½•* è®¿å®¢å°è¯•é€šè¿‡ API ç¼–è¾‘æˆ–åˆ é™¤äº‹ä»¶çš„æ“ä½œï¼ŒRLS ç­–ç•¥åº”è¯¥é˜»æ­¢å¹¶è¿”å›æƒé™é”™è¯¯
**éªŒè¯éœ€æ±‚: 3.6**

#### Property 13: è®¿å®¢ LLM é…é¢æ£€æŸ¥
*å¯¹äºä»»ä½•* è®¿å®¢è°ƒç”¨ LLM çš„è¯·æ±‚ï¼Œç³»ç»Ÿåº”è¯¥å…ˆæ£€æŸ¥ visitor_sessions è¡¨çš„ llm_used_count
**éªŒè¯éœ€æ±‚: 4.1**

#### Property 14: è®¿å®¢ LLM è°ƒç”¨ï¼ˆé…é¢å†…ï¼‰
*å¯¹äºä»»ä½•* llm_used_count ç­‰äº 0 çš„è®¿å®¢ï¼Œç³»ç»Ÿåº”è¯¥å…è®¸è°ƒç”¨çœŸå®çš„ LLM API
**éªŒè¯éœ€æ±‚: 4.2**

#### Property 15: LLM é…é¢æ¶ˆè€—
*å¯¹äºä»»ä½•* æˆåŠŸçš„ LLM API è°ƒç”¨ï¼Œç³»ç»Ÿåº”è¯¥å°† llm_used_count è®¾ç½®ä¸º 1
**éªŒè¯éœ€æ±‚: 4.4**

#### Property 16: Token è¿½è¸ª
*å¯¹äºä»»ä½•* æˆåŠŸçš„ LLM API è°ƒç”¨ï¼Œå¦‚æœè¿”å› Token æ¶ˆè€—æ•°æ®ï¼Œç³»ç»Ÿåº”è¯¥è®°å½•åˆ° llm_token_used å­—æ®µ
**éªŒè¯éœ€æ±‚: 4.6**

#### Property 17: æ‰¹é‡äº‹ä»¶åˆ›å»ºé…é¢é™åˆ¶
*å¯¹äºä»»ä½•* LLM è§£æå‡ºçš„å¤šä¸ªäº‹ä»¶ï¼Œç³»ç»Ÿåº”è¯¥åªåˆ›å»ºå‰ N ä¸ªäº‹ä»¶ï¼Œå…¶ä¸­ N = min(è§£ææ•°é‡, å‰©ä½™é…é¢)
**éªŒè¯éœ€æ±‚: 4.8**

#### Property 18: ç®¡ç†å‘˜æ•°æ®åŠ è½½
*å¯¹äºä»»ä½•* æˆåŠŸç™»å½•çš„ç®¡ç†å‘˜ï¼Œç³»ç»Ÿåº”è¯¥ä» events è¡¨åŠ è½½æ‰€æœ‰äº‹ä»¶æ•°æ®
**éªŒè¯éœ€æ±‚: 5.1**

#### Property 19: ç®¡ç†å‘˜æ•°æ®éš”ç¦»
*å¯¹äºä»»ä½•* ç®¡ç†å‘˜åˆ›å»ºã€ç¼–è¾‘æˆ–åˆ é™¤çš„äº‹ä»¶ï¼Œæ“ä½œåº”è¯¥åªå½±å“ events è¡¨ï¼Œä¸å½±å“ visitor_events è¡¨
**éªŒè¯éœ€æ±‚: 5.2, 5.3, 5.4**

#### Property 20: ç®¡ç†å‘˜ LLM æ— é™åˆ¶
*å¯¹äºä»»ä½•* ç®¡ç†å‘˜æ¨¡å¼ä¸‹çš„ LLM è°ƒç”¨ï¼Œç³»ç»Ÿåº”è¯¥ä½¿ç”¨çœŸå®çš„ LLM API ä¸”ä¸æ£€æŸ¥é…é¢é™åˆ¶
**éªŒè¯éœ€æ±‚: 5.5**

#### Property 21: ç®¡ç†å‘˜ä¼šè¯æŒä¹…æ€§
*å¯¹äºä»»ä½•* ç®¡ç†å‘˜ä¼šè¯ï¼Œåˆ·æ–°é¡µé¢ååº”è¯¥é€šè¿‡ Supabase Auth æ¢å¤ä¼šè¯å¹¶ä¿æŒç®¡ç†å‘˜æ¨¡å¼
**éªŒè¯éœ€æ±‚: 5.6, 6.6**

#### Property 22: ç®¡ç†å‘˜ UI æƒé™
*å¯¹äºä»»ä½•* ç®¡ç†å‘˜æ¨¡å¼çš„ç”¨æˆ·ï¼Œç³»ç»Ÿåº”è¯¥éšè—è®¿å®¢æ¨ªå¹…å¹¶æ˜¾ç¤ºæ‰€æœ‰åŠŸèƒ½ï¼ˆç¼–è¾‘ã€åˆ é™¤ã€æ‰¹é‡æ“ä½œã€å¯¼å…¥å¯¼å‡ºã€ç›‘æ§é¡µé¢ï¼‰
**éªŒè¯éœ€æ±‚: 5.7, 5.8**

#### Property 23: åº”ç”¨å¯åŠ¨æ¨¡å¼é€‰æ‹©
*å¯¹äºä»»ä½•* åº”ç”¨å¯åŠ¨ï¼Œå¦‚æœå­˜åœ¨æœ‰æ•ˆçš„ Supabase Auth ä¼šè¯åˆ™è¿›å…¥ç®¡ç†å‘˜æ¨¡å¼ï¼Œå¦åˆ™è¿›å…¥è®¿å®¢æ¨¡å¼
**éªŒè¯éœ€æ±‚: 6.2, 6.3**

#### Property 24: è®¿å®¢åˆ°ç®¡ç†å‘˜æ¨¡å¼åˆ‡æ¢
*å¯¹äºä»»ä½•* ä»è®¿å®¢æ¨¡å¼åˆ‡æ¢åˆ°ç®¡ç†å‘˜æ¨¡å¼çš„æ“ä½œï¼Œç³»ç»Ÿåº”è¯¥æ¸…ç©ºè®¿å®¢æ•°æ®å¹¶ä» events è¡¨åŠ è½½ç®¡ç†å‘˜æ•°æ®
**éªŒè¯éœ€æ±‚: 6.4**

#### Property 25: ç®¡ç†å‘˜åˆ°è®¿å®¢æ¨¡å¼åˆ‡æ¢
*å¯¹äºä»»ä½•* ä»ç®¡ç†å‘˜æ¨¡å¼åˆ‡æ¢åˆ°è®¿å®¢æ¨¡å¼çš„æ“ä½œï¼Œç³»ç»Ÿåº”è¯¥æ¸…ç©ºç®¡ç†å‘˜æ•°æ®å¹¶ä» visitor_events è¡¨åŠ è½½è®¿å®¢æ•°æ®
**éªŒè¯éœ€æ±‚: 6.5**

#### Property 26: ç›‘æ§é¡µé¢æƒé™æ£€æŸ¥
*å¯¹äºä»»ä½•* è®¿é—®ç›‘æ§é¡µé¢çš„è¯·æ±‚ï¼Œç³»ç»Ÿåº”è¯¥æ£€æŸ¥ Supabase Auth ä¼šè¯çŠ¶æ€
**éªŒè¯éœ€æ±‚: 7.1**

#### Property 27: ç›‘æ§é¡µé¢æ•°æ®åŠ è½½
*å¯¹äºä»»ä½•* å·²ç™»å½•çš„ç®¡ç†å‘˜è®¿é—®ç›‘æ§é¡µé¢ï¼Œç³»ç»Ÿåº”è¯¥æ˜¾ç¤ºæ‰€æœ‰è®¿å®¢ä¼šè¯åˆ—è¡¨ï¼ŒåŒ…å«æŒ‡çº¹ã€LLM è°ƒç”¨æ¬¡æ•°ã€Token æ¶ˆè€—ã€äº‹ä»¶æ•°é‡ã€åˆ›å»ºæ—¶é—´ã€æœ€åæ´»è·ƒæ—¶é—´
**éªŒè¯éœ€æ±‚: 7.3, 7.4**

#### Property 28: ç›‘æ§é¡µé¢äº‹ä»¶è¯¦æƒ…
*å¯¹äºä»»ä½•* ç®¡ç†å‘˜ç‚¹å‡»çš„è®¿å®¢ä¼šè¯ï¼Œç³»ç»Ÿåº”è¯¥æ˜¾ç¤ºè¯¥è®¿å®¢åˆ›å»ºçš„æ‰€æœ‰äº‹ä»¶ï¼ŒåŒ…å«æ ‡é¢˜ã€å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€åˆ›å»ºæ—¶é—´
**éªŒè¯éœ€æ±‚: 7.5, 7.6**

#### Property 29: ç›‘æ§é¡µé¢ç»Ÿè®¡æ•°æ®
*å¯¹äºä»»ä½•* ç®¡ç†å‘˜æŸ¥çœ‹ç›‘æ§é¡µé¢çš„æ“ä½œï¼Œç³»ç»Ÿåº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„ç»Ÿè®¡æ•°æ®ï¼ˆæ€»è®¿å®¢æ•°ã€æ€» LLM è°ƒç”¨æ¬¡æ•°ã€æ€» Token æ¶ˆè€—ã€æ€»äº‹ä»¶æ•°ï¼‰
**éªŒè¯éœ€æ±‚: 7.7**

#### Property 30: å®šæ—¶æ¸…ç†æ‰§è¡Œ
*å¯¹äºä»»ä½•* å®šæ—¶ä»»åŠ¡æ‰§è¡Œï¼Œç³»ç»Ÿåº”è¯¥åˆ é™¤ visitor_sessions è¡¨ä¸­ created_at è¶…è¿‡ 1 å¤©çš„è®°å½•
**éªŒè¯éœ€æ±‚: 8.1**

#### Property 31: çº§è”åˆ é™¤
*å¯¹äºä»»ä½•* åˆ é™¤çš„ visitor_sessions è®°å½•ï¼Œç³»ç»Ÿåº”è¯¥é€šè¿‡å¤–é”®çº§è”åˆ é™¤å…³è”çš„ visitor_events è®°å½•
**éªŒè¯éœ€æ±‚: 8.2**

#### Property 32: æ¸…ç†æ—¥å¿—è®°å½•
*å¯¹äºä»»ä½•* å®šæ—¶æ¸…ç†æ“ä½œï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰ï¼Œç³»ç»Ÿåº”è¯¥åœ¨æ•°æ®åº“æ—¥å¿—ä¸­è®°å½•ç›¸åº”ä¿¡æ¯
**éªŒè¯éœ€æ±‚: 8.3**

#### Property 33: æ¸…ç†æ—¶é—´æ˜¾ç¤º
*å¯¹äºä»»ä½•* ç®¡ç†å‘˜æŸ¥çœ‹ç›‘æ§é¡µé¢çš„æ“ä½œï¼Œç³»ç»Ÿåº”è¯¥æ˜¾ç¤ºæœ€åæ¸…ç†æ—¶é—´
**éªŒè¯éœ€æ±‚: 8.5**

## é”™è¯¯å¤„ç†

### é”™è¯¯åˆ†ç±»

#### 1. è®¤è¯é”™è¯¯
- **æ— æ•ˆå‡­è¯**ï¼šæ˜¾ç¤º "é‚®ç®±æˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•"
- **ä¼šè¯è¿‡æœŸ**ï¼šè‡ªåŠ¨è¿”å›è®¿å®¢æ¨¡å¼ï¼Œæç¤º "ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•"
- **ç½‘ç»œé”™è¯¯**ï¼šæ˜¾ç¤º "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•"

#### 2. é…é¢é”™è¯¯
- **LLM é…é¢ç”¨å°½**ï¼šæ˜¾ç¤º "è¯•ç”¨æ¬¡æ•°å·²ç”¨å®Œï¼ˆ1/1ï¼‰ï¼Œè¯·ç™»å½•è·å–æ— é™è°ƒç”¨"
- **äº‹ä»¶é…é¢ç”¨å°½**ï¼šæ˜¾ç¤º "å·²è¾¾åˆ°è¯•ç”¨ä¸Šé™ï¼ˆ3 æ¡ï¼‰ï¼Œè¯·ç™»å½•è·å–æ— é™å­˜å‚¨"
- **æ‰¹é‡åˆ›å»ºè¶…é…é¢**ï¼šæ˜¾ç¤º "å·²åˆ›å»º X/Y ä¸ªäº‹ä»¶ï¼Œå‰©ä½™é…é¢ä¸è¶³ï¼Œè¯·ç™»å½•è·å–æ— é™å­˜å‚¨"

#### 3. æ•°æ®åº“é”™è¯¯
- **è¿æ¥å¤±è´¥**ï¼šæ˜¾ç¤º "æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"
- **RLS æƒé™é”™è¯¯**ï¼šæ˜¾ç¤º "æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ­¤æ“ä½œ"
- **å¤–é”®çº¦æŸé”™è¯¯**ï¼šæ˜¾ç¤º "æ•°æ®å…³è”é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•"

#### 4. LLM API é”™è¯¯
- **API è°ƒç”¨å¤±è´¥**ï¼šä¸æ¶ˆè€—é…é¢ï¼Œæ˜¾ç¤º "LLM æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"
- **è§£æå¤±è´¥**ï¼šä¸æ¶ˆè€—é…é¢ï¼Œæ˜¾ç¤º "æ— æ³•è§£æè¾“å…¥å†…å®¹ï¼Œè¯·å°è¯•æ›´æ¸…æ™°çš„æè¿°"
- **è¶…æ—¶**ï¼šä¸æ¶ˆè€—é…é¢ï¼Œæ˜¾ç¤º "è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•"

#### 5. æƒé™é”™è¯¯
- **è®¿å®¢å°è¯•ç¼–è¾‘/åˆ é™¤**ï¼šå‰ç«¯éšè—æŒ‰é’®ï¼Œåç«¯ RLS é˜»æ­¢
- **éç®¡ç†å‘˜è®¿é—®ç›‘æ§é¡µé¢**ï¼šæ˜¾ç¤º "æ­¤é¡µé¢ä»…é™ç®¡ç†å‘˜è®¿é—®"

### é”™è¯¯å¤„ç†ç­–ç•¥

#### å‰ç«¯é”™è¯¯å¤„ç†
```typescript
// ä½¿ç”¨ Element Plus æ¶ˆæ¯ç»„ä»¶
import { ElMessage, ElNotification } from 'element-plus'

// ç”¨æˆ·æ“ä½œé”™è¯¯ï¼ˆé…é¢ã€æƒé™ï¼‰
ElMessage.warning('è¯•ç”¨æ¬¡æ•°å·²ç”¨å®Œï¼ˆ1/1ï¼‰ï¼Œè¯·ç™»å½•è·å–æ— é™è°ƒç”¨')

// ç³»ç»Ÿé”™è¯¯ï¼ˆç½‘ç»œã€æ•°æ®åº“ï¼‰
ElMessage.error('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')

// æˆåŠŸæç¤º
ElMessage.success('ç™»å½•æˆåŠŸ')

// é‡è¦é€šçŸ¥
ElNotification({
  title: 'é…é¢æé†’',
  message: 'å·²åˆ›å»º 2/3 ä¸ªäº‹ä»¶ï¼Œå‰©ä½™ 1 ä¸ªé…é¢',
  type: 'info'
})
```

#### åç«¯é”™è¯¯å¤„ç†
- **RLS ç­–ç•¥**ï¼šè‡ªåŠ¨é˜»æ­¢æœªæˆæƒæ“ä½œï¼Œè¿”å› 403 é”™è¯¯
- **å®šæ—¶æ¸…ç†å¤±è´¥**ï¼šè®°å½•æ—¥å¿—ä½†ä¸å½±å“åº”ç”¨è¿è¡Œ
- **å¤–é”®çº§è”**ï¼šè‡ªåŠ¨å¤„ç†å…³è”æ•°æ®åˆ é™¤

#### é”™è¯¯æ¢å¤
- **ä¼šè¯è¿‡æœŸ**ï¼šè‡ªåŠ¨åˆ‡æ¢åˆ°è®¿å®¢æ¨¡å¼ï¼Œä¿ç•™å½“å‰é¡µé¢çŠ¶æ€
- **ç½‘ç»œé”™è¯¯**ï¼šæä¾›é‡è¯•æŒ‰é’®
- **LLM å¤±è´¥**ï¼šä¸æ¶ˆè€—é…é¢ï¼Œå…è®¸é‡è¯•

### æ—¥å¿—è®°å½•

#### å‰ç«¯æ—¥å¿—
```typescript
// å¼€å‘ç¯å¢ƒï¼šè¯¦ç»†æ—¥å¿—
if (import.meta.env.DEV) {
  console.log('[Auth] Switching to admin mode', { session })
}

// ç”Ÿäº§ç¯å¢ƒï¼šä»…é”™è¯¯æ—¥å¿—
console.error('[Auth] Login failed', { error })
```

#### åç«¯æ—¥å¿—
```sql
-- å®šæ—¶æ¸…ç†æ—¥å¿—
RAISE NOTICE 'Cleaned up % visitor sessions', deleted_sessions;

-- é”™è¯¯æ—¥å¿—
RAISE WARNING 'Cleanup failed: %', error_message;
```

## æµ‹è¯•ç­–ç•¥

### æµ‹è¯•æ¡†æ¶
- **å•å…ƒæµ‹è¯•**ï¼šVitest
- **å±æ€§æµ‹è¯•**ï¼šfast-check (JavaScript/TypeScript çš„å±æ€§æµ‹è¯•åº“)
- **é›†æˆæµ‹è¯•**ï¼šVitest + Supabase æµ‹è¯•ç¯å¢ƒ

### å±æ€§æµ‹è¯•é…ç½®

æ¯ä¸ªå±æ€§æµ‹è¯•åº”è¯¥ï¼š
- è¿è¡Œè‡³å°‘ 100 æ¬¡è¿­ä»£ï¼ˆfast-check é»˜è®¤é…ç½®ï¼‰
- ä½¿ç”¨æ³¨é‡Šæ ‡è®°å¯¹åº”çš„è®¾è®¡æ–‡æ¡£å±æ€§
- æ ¼å¼ï¼š`**Feature: user-authentication, Property {number}: {property_text}**`

ç¤ºä¾‹ï¼š
```typescript
import fc from 'fast-check'
import { describe, it, expect } from 'vitest'

describe('Property Tests', () => {
  /**
   * **Feature: user-authentication, Property 1: æŒ‡çº¹ç¨³å®šæ€§**
   * å¯¹äºä»»ä½•æµè§ˆå™¨ç¯å¢ƒï¼Œåœ¨ç›¸åŒçš„æµè§ˆå™¨ä¼šè¯ä¸­å¤šæ¬¡ç”ŸæˆæŒ‡çº¹åº”è¯¥è¿”å›ç›¸åŒçš„å€¼
   */
  it('should generate stable fingerprint in same session', async () => {
    await fc.assert(
      fc.asyncProperty(fc.integer(), async (seed) => {
        const fp1 = await generateFingerprint()
        const fp2 = await generateFingerprint()
        expect(fp1).toBe(fp2)
      }),
      { numRuns: 100 }
    )
  })
})
```

### å•å…ƒæµ‹è¯•é‡ç‚¹

#### 1. useAuth Composable
- æŒ‡çº¹ç”Ÿæˆå’Œç¨³å®šæ€§
- ç™»å½•/ç™»å‡ºæµç¨‹
- ä¼šè¯æ¢å¤
- æ¨¡å¼åˆ‡æ¢é€»è¾‘
- é…é¢æŸ¥è¯¢

#### 2. useVisitorEvents Composable
- äº‹ä»¶ CRUDï¼ˆä»… Create + Readï¼‰
- é…é¢æ£€æŸ¥ï¼ˆäº‹ä»¶æ•°é‡ + LLM è°ƒç”¨ï¼‰
- LLM è°ƒç”¨å’Œ Token è¿½è¸ª
- æ•°æ®è¿‡æ»¤ï¼ˆfingerprintï¼‰

#### 3. useMonitoring Composable
- è®¿å®¢ä¼šè¯æŸ¥è¯¢
- ç»Ÿè®¡æ•°æ®è®¡ç®—
- æƒé™æ£€æŸ¥

#### 4. UI ç»„ä»¶
- VisitorBannerï¼šé…é¢æ˜¾ç¤ºæ­£ç¡®æ€§
- AdminLoginDialogï¼šè¡¨å•éªŒè¯
- MonitoringPageï¼šæ•°æ®æ¸²æŸ“å’Œæƒé™ä¿æŠ¤

### é›†æˆæµ‹è¯•é‡ç‚¹

#### 1. è®¿å®¢æ¨¡å¼ç«¯åˆ°ç«¯æµç¨‹
```typescript
describe('Visitor Mode E2E', () => {
  it('should complete visitor journey', async () => {
    // 1. æ‰“å¼€åº”ç”¨ â†’ ç”ŸæˆæŒ‡çº¹
    // 2. åˆ›å»º 3 ä¸ªäº‹ä»¶ â†’ é…é¢ç”¨å°½
    // 3. è°ƒç”¨ LLM 1 æ¬¡ â†’ é…é¢ç”¨å°½
    // 4. åˆ·æ–°é¡µé¢ â†’ æ¢å¤æ•°æ®
  })
})
```

#### 2. ç®¡ç†å‘˜æ¨¡å¼ç«¯åˆ°ç«¯æµç¨‹
```typescript
describe('Admin Mode E2E', () => {
  it('should complete admin journey', async () => {
    // 1. ç™»å½• â†’ åˆ‡æ¢åˆ°ç®¡ç†å‘˜æ¨¡å¼
    // 2. åˆ›å»º/ç¼–è¾‘/åˆ é™¤äº‹ä»¶ â†’ æ— é™åˆ¶
    // 3. è°ƒç”¨ LLM â†’ æ— é™åˆ¶
    // 4. è®¿é—®ç›‘æ§é¡µé¢ â†’ æŸ¥çœ‹è®¿å®¢æ•°æ®
    // 5. ç™»å‡º â†’ è¿”å›è®¿å®¢æ¨¡å¼
  })
})
```

#### 3. æƒé™åˆ‡æ¢æµç¨‹
```typescript
describe('Mode Switching', () => {
  it('should switch between visitor and admin modes', async () => {
    // 1. è®¿å®¢æ¨¡å¼ â†’ åˆ›å»ºäº‹ä»¶
    // 2. ç™»å½• â†’ åˆ‡æ¢åˆ°ç®¡ç†å‘˜æ¨¡å¼ â†’ è®¿å®¢æ•°æ®æ¸…ç©º
    // 3. ç®¡ç†å‘˜æ¨¡å¼ â†’ åˆ›å»ºäº‹ä»¶
    // 4. ç™»å‡º â†’ åˆ‡æ¢åˆ°è®¿å®¢æ¨¡å¼ â†’ ç®¡ç†å‘˜æ•°æ®æ¸…ç©º
  })
})
```

### æ•°æ®åº“æµ‹è¯•

#### RLS ç­–ç•¥æµ‹è¯•
```sql
-- æµ‹è¯•è®¿å®¢æ— æ³•æ›´æ–°äº‹ä»¶
BEGIN;
SET ROLE anon;
UPDATE visitor_events SET title = 'hacked' WHERE id = 'xxx';
-- åº”è¯¥å¤±è´¥
ROLLBACK;

-- æµ‹è¯•æœªè®¤è¯ç”¨æˆ·æ— æ³•è®¿é—®ç®¡ç†å‘˜äº‹ä»¶
BEGIN;
SET ROLE anon;
SELECT * FROM events;
-- åº”è¯¥è¿”å›ç©ºæˆ–é”™è¯¯
ROLLBACK;
```

#### å®šæ—¶æ¸…ç†æµ‹è¯•
```sql
-- æ’å…¥è¿‡æœŸæ•°æ®
INSERT INTO visitor_sessions (fingerprint, created_at)
VALUES ('test-fp', NOW() - INTERVAL '2 days');

-- æ‰§è¡Œæ¸…ç†
SELECT cleanup_visitor_data();

-- éªŒè¯æ•°æ®å·²åˆ é™¤
SELECT COUNT(*) FROM visitor_sessions WHERE fingerprint = 'test-fp';
-- åº”è¯¥è¿”å› 0
```

### æ€§èƒ½æµ‹è¯•

#### é…é¢æŸ¥è¯¢æ€§èƒ½
```typescript
describe('Performance', () => {
  it('should query event quota efficiently', async () => {
    // åˆ›å»º 3 ä¸ªäº‹ä»¶
    // æµ‹é‡ COUNT æŸ¥è¯¢æ—¶é—´
    // åº”è¯¥ < 100ms
  })
})
```

#### å¤§é‡è®¿å®¢ä¼šè¯
```typescript
describe('Scalability', () => {
  it('should handle 1000+ visitor sessions', async () => {
    // åˆ›å»º 1000 ä¸ªè®¿å®¢ä¼šè¯
    // æµ‹é‡ç›‘æ§é¡µé¢åŠ è½½æ—¶é—´
    // åº”è¯¥ < 2s
  })
})
```

### æµ‹è¯•æ•°æ®ç®¡ç†

#### æµ‹è¯•ç¯å¢ƒéš”ç¦»
- ä½¿ç”¨ç‹¬ç«‹çš„ Supabase æµ‹è¯•é¡¹ç›®
- æ¯ä¸ªæµ‹è¯•å‰æ¸…ç©ºæ•°æ®åº“
- ä½¿ç”¨æµ‹è¯•ä¸“ç”¨çš„ Anon Key

#### æµ‹è¯•æ•°æ®ç”Ÿæˆ
```typescript
// ç”Ÿæˆéšæœºè®¿å®¢ä¼šè¯
const generateVisitorSession = () => ({
  fingerprint: `test-fp-${Math.random()}`,
  llm_used_count: Math.random() > 0.5 ? 1 : 0,
  llm_token_used: Math.floor(Math.random() * 1000)
})

// ç”Ÿæˆéšæœºè®¿å®¢äº‹ä»¶
const generateVisitorEvent = (fingerprint: string) => ({
  fingerprint,
  title: `Test Event ${Math.random()}`,
  start_time: new Date().toISOString(),
  end_time: new Date(Date.now() + 3600000).toISOString(),
  is_all_day: false
})
```

## å®ç°è®¡åˆ’æ¦‚è¿°

### Phase 1: æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼ˆç¬¬ 1-2 å¤©ï¼‰
1. æ•°æ®åº“è¿ç§»ï¼ˆåˆ›å»ºè¡¨ã€RLS ç­–ç•¥ã€å®šæ—¶æ¸…ç†ï¼‰
2. useAuth composableï¼ˆæŒ‡çº¹ç”Ÿæˆã€ç™»å½•/ç™»å‡ºã€æ¨¡å¼åˆ‡æ¢ï¼‰
3. useVisitorEvents composableï¼ˆäº‹ä»¶ CRUDã€é…é¢æ£€æŸ¥ï¼‰

### Phase 2: UI ç»„ä»¶ï¼ˆç¬¬ 2-3 å¤©ï¼‰
1. VisitorBanner ç»„ä»¶ï¼ˆé…é¢æ˜¾ç¤ºï¼‰
2. AdminLoginDialog ç»„ä»¶ï¼ˆç™»å½•è¡¨å•ï¼‰
3. ä¿®æ”¹ç°æœ‰ useEventsï¼ˆæ·»åŠ èº«ä»½æ£€æŸ¥ï¼‰
4. ä¿®æ”¹ç°æœ‰ UI ç»„ä»¶ï¼ˆæƒé™æ§åˆ¶ï¼‰

### Phase 3: ç›‘æ§åŠŸèƒ½ï¼ˆç¬¬ 3 å¤©ï¼‰
1. useMonitoring composableï¼ˆè®¿å®¢æ•°æ®æŸ¥è¯¢ï¼‰
2. MonitoringPage ç»„ä»¶ï¼ˆç›‘æ§é¡µé¢ï¼‰
3. è·¯ç”±å’Œæƒé™ä¿æŠ¤

### Phase 4: æµ‹è¯•å’Œä¼˜åŒ–ï¼ˆç¬¬ 3 å¤©ï¼‰
1. å•å…ƒæµ‹è¯•ï¼ˆcomposablesï¼‰
2. å±æ€§æµ‹è¯•ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
3. é›†æˆæµ‹è¯•ï¼ˆç«¯åˆ°ç«¯æµç¨‹ï¼‰
4. æ€§èƒ½ä¼˜åŒ–

## å…³é”®å®ç°ç»†èŠ‚ä¸æœ€ä½³å®è·µ

### 1. ç«æ€æ¡ä»¶å¤„ç†ï¼ˆLoading çŠ¶æ€ï¼‰

**é—®é¢˜åœºæ™¯**ï¼š
åº”ç”¨å¯åŠ¨æ—¶ï¼ŒSupabase Auth æ£€æŸ¥ä¼šè¯æ˜¯å¼‚æ­¥çš„ï¼ˆçº¦ 500msï¼‰ï¼š
1. åˆå§‹çŠ¶æ€ï¼š`adminSession = null` â†’ ç³»ç»Ÿåˆ¤å®šä¸ºè®¿å®¢ â†’ ç”ŸæˆæŒ‡çº¹
2. 500ms åï¼šSupabase è¿”å› Session â†’ ç³»ç»Ÿåˆ‡æ¢ä¸ºç®¡ç†å‘˜

**åæœ**ï¼šç®¡ç†å‘˜ä¼šçœ‹åˆ°çŸ­æš‚çš„"è®¿å®¢æ¨ªå¹…"é—ªçƒï¼Œä½“éªŒä¸ä½³

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// useAuth.ts
export function useAuth() {
  const isAuthChecking = ref(true)  // åˆå§‹ä¸º true
  const mode = ref<'visitor' | 'admin'>('visitor')
  
  // åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥ä¼šè¯
  onMounted(async () => {
    isAuthChecking.value = true
    
    const { data: { session } } = await supabase.auth.getSession()
    
    if (session) {
      mode.value = 'admin'
      adminSession.value = session
    } else {
      mode.value = 'visitor'
      await initVisitorMode()
    }
    
    isAuthChecking.value = false  // èº«ä»½ç¡®å®šåè®¾ä¸º false
  })
  
  return { isAuthChecking, mode, ... }
}
```

```vue
<!-- App.vue -->
<template>
  <!-- å…¨å± Loadingï¼Œé˜»æ­¢ä¸šåŠ¡ç»„ä»¶æ¸²æŸ“ -->
  <div v-if="isAuthChecking" class="auth-loading-overlay">
    <el-icon class="is-loading" :size="40"><Loading /></el-icon>
    <p>æ­£åœ¨åŠ è½½...</p>
  </div>
  
  <!-- èº«ä»½ç¡®å®šåæ‰æ¸²æŸ“ä¸šåŠ¡ç»„ä»¶ -->
  <div v-else>
    <VisitorBanner v-if="mode === 'visitor'" />
    <EventList />
    <!-- å…¶ä»–ç»„ä»¶ -->
  </div>
</template>

<style scoped>
.auth-loading-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: var(--el-bg-color);
  z-index: 9999;
}
</style>
```

### 2. RLS æ¶æ„æ’å…¥é˜²æŠ¤ï¼ˆæ•°æ®åº“å±‚é¢é…é¢æ£€æŸ¥ï¼‰

**å®‰å…¨é£é™©**ï¼š
è™½ç„¶å‰ç«¯æœ‰é…é¢æ£€æŸ¥ï¼Œä½†æ‡‚æŠ€æœ¯çš„æ¶æ„ç”¨æˆ·å¯ä»¥ï¼š
- ç›´æ¥è°ƒç”¨ Supabase APIï¼ˆç»•è¿‡å‰ç«¯ï¼‰
- åœ¨ä¸€ä¸ªæŒ‡çº¹ä¸‹æ’å…¥ 10,000+ æ¡æ•°æ®
- æ¶ˆè€—æ•°æ®åº“ååé‡ï¼ˆè™½ç„¶ 1 å¤©åä¼šè¢«åˆ é™¤ï¼‰

**åŸå§‹ç­–ç•¥ï¼ˆä¸å®‰å…¨ï¼‰**ï¼š
```sql
CREATE POLICY "Allow public insert" ON visitor_events
  FOR INSERT WITH CHECK (true);  -- âŒ æ— é™åˆ¶
```

**åŠ å›ºç­–ç•¥ï¼ˆæ¨èï¼‰**ï¼š
```sql
CREATE POLICY "Allow public insert with quota check" ON visitor_events
  FOR INSERT WITH CHECK (
    (SELECT COUNT(*) FROM visitor_events 
     WHERE fingerprint = visitor_events.fingerprint) < 3
  );
```

**æ€§èƒ½å½±å“**ï¼š
- æ¯æ¬¡æ’å…¥å¢åŠ çº¦ 10-20msï¼ˆCOUNT æŸ¥è¯¢ï¼‰
- å¯¹äº MVP ä½å¹¶å‘åœºæ™¯å®Œå…¨å¯æ¥å—
- å®‰å…¨æ”¶ç›Šè¿œå¤§äºæ€§èƒ½æˆæœ¬

**å‰åç«¯åŒé‡ä¿æŠ¤**ï¼š
- å‰ç«¯ï¼šé…é¢æ£€æŸ¥ â†’ å³æ—¶åé¦ˆï¼Œæ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- åç«¯ï¼šRLS ç­–ç•¥ â†’ é˜²æ­¢æ¶æ„ç»•è¿‡ï¼Œæœ€åä¸€é“é˜²çº¿

### 3. æ—¶åŒºå¤„ç†è§„èŒƒï¼ˆUTC ç»Ÿä¸€æ ‡å‡†ï¼‰

**é—®é¢˜**ï¼š
è®¿å®¢æ˜¯åŒ¿åçš„ï¼Œæ— æ³•å­˜å‚¨æ—¶åŒºåå¥½è®¾ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼šç»Ÿä¸€ä½¿ç”¨ UTC æ—¶é—´

#### å‰ç«¯å‘é€ï¼ˆåˆ›å»ºäº‹ä»¶ï¼‰
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ Day.js è½¬æ¢ä¸º UTC
import dayjs from 'dayjs'
import utc from 'dayjs/plugin/utc'

dayjs.extend(utc)

const event = {
  title: 'ä¼šè®®',
  start_time: dayjs(startDate).utc().toISOString(),  // '2024-01-15T14:30:00.000Z'
  end_time: dayjs(endDate).utc().toISOString()
}

await supabase.from('visitor_events').insert(event)
```

```typescript
// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨æœ¬åœ°æ—¶é—´
const event = {
  start_time: new Date().toISOString()  // å¯èƒ½åŒ…å«æ—¶åŒºåç§»
}
```

#### æ•°æ®åº“å­˜å‚¨
```sql
-- TIMESTAMPTZ è‡ªåŠ¨å¤„ç†æ—¶åŒº
CREATE TABLE visitor_events (
  start_time TIMESTAMPTZ NOT NULL,  -- PostgreSQL å†…éƒ¨ä»¥ UTC å­˜å‚¨
  end_time TIMESTAMPTZ NOT NULL
);
```

#### å‰ç«¯æ˜¾ç¤ºï¼ˆæŸ¥è¯¢äº‹ä»¶ï¼‰
```typescript
// âœ… æ­£ç¡®ï¼šæ ¹æ®æµè§ˆå™¨æ—¶åŒºæ˜¾ç¤º
import dayjs from 'dayjs'

const displayTime = dayjs(event.start_time)
  .local()  // è½¬æ¢ä¸ºæœ¬åœ°æ—¶åŒº
  .format('YYYY-MM-DD HH:mm')  // '2024-01-15 22:30'ï¼ˆå‡è®¾ UTC+8ï¼‰
```

```vue
<!-- æˆ–ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿ API -->
<template>
  <p>{{ new Date(event.start_time).toLocaleString() }}</p>
</template>
```

#### å¯é€‰å¢å¼ºï¼ˆPhase 3ï¼‰
```sql
-- åœ¨ visitor_sessions è¡¨æ·»åŠ æ—¶åŒºå­—æ®µï¼ˆç”¨äºç›‘æ§ï¼‰
ALTER TABLE visitor_sessions ADD COLUMN timezone TEXT;
```

```typescript
// å‰ç«¯è®°å½•è®¿å®¢æ—¶åŒº
const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone  // 'Asia/Shanghai'

await supabase.from('visitor_sessions').insert({
  fingerprint,
  timezone
})
```

## æŠ€æœ¯é£é™©å’Œç¼“è§£æªæ–½

### é£é™© 1: æŒ‡çº¹ä¸ç¨³å®š
**é£é™©**ï¼šç”¨æˆ·æ¸…é™¤æµè§ˆå™¨æ•°æ®æˆ–ä½¿ç”¨éšç§æ¨¡å¼å¯¼è‡´æŒ‡çº¹å˜åŒ–
**ç¼“è§£**ï¼š
- è¿™æ˜¯é¢„æœŸè¡Œä¸ºï¼Œåœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜
- ç”¨æˆ·å¯ä»¥é‡æ–°è·å¾— 1 æ¬¡è¯•ç”¨æœºä¼š
- åœ¨æ¨ªå¹…ä¸­æç¤ºç”¨æˆ·ç™»å½•ä»¥ä¿å­˜æ•°æ®

### é£é™© 2: æ¶æ„ç”¨æˆ·ç»•è¿‡é…é¢
**é£é™©**ï¼šç”¨æˆ·é€šè¿‡æ¸…é™¤æµè§ˆå™¨æ•°æ®æˆ–åˆ‡æ¢æµè§ˆå™¨ç»•è¿‡é…é¢é™åˆ¶
**ç¼“è§£**ï¼š
- æˆæœ¬å·²ç»å¾ˆä½ï¼ˆ1 æ¬¡ LLM + 3 æ¡äº‹ä»¶ï¼‰
- 1 å¤©è‡ªåŠ¨æ¸…ç†ï¼Œé™åˆ¶æ•°æ®ç§¯ç´¯
- **ğŸ”¥ å·²å®æ–½**ï¼šæ•°æ®åº“å±‚é¢ RLS é…é¢æ£€æŸ¥ï¼Œé˜²æ­¢ç›´æ¥ API è°ƒç”¨ç»•è¿‡
- Phase 3 å¯ä»¥æ·»åŠ  IP é™æµï¼ˆå¯é€‰ï¼‰

### é£é™© 3: RLS ç­–ç•¥é…ç½®é”™è¯¯
**é£é™©**ï¼šRLS ç­–ç•¥é…ç½®ä¸å½“å¯¼è‡´æ•°æ®æ³„éœ²æˆ–è®¿é—®å¤±è´¥
**ç¼“è§£**ï¼š
- åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†æµ‹è¯• RLS ç­–ç•¥
- ä½¿ç”¨ Supabase Dashboard éªŒè¯ç­–ç•¥
- å‰ç«¯ + åç«¯åŒé‡ä¿æŠ¤
- ç¼–å†™ RLS ç­–ç•¥æµ‹è¯•

### é£é™© 4: å®šæ—¶æ¸…ç†å¤±è´¥
**é£é™©**ï¼špg_cron é…ç½®é”™è¯¯æˆ–æ‰§è¡Œå¤±è´¥å¯¼è‡´æ•°æ®ç§¯ç´¯
**ç¼“è§£**ï¼š
- åœ¨ç›‘æ§é¡µé¢æ˜¾ç¤ºæœ€æ—§è®°å½•æ—¶é—´
- æ‰‹åŠ¨æ¸…ç†å¤‡ç”¨æ–¹æ¡ˆ
- æ•°æ®åº“å­˜å‚¨æˆæœ¬ä½ï¼ŒçŸ­æœŸç§¯ç´¯å½±å“å°
- å®šæ—¶æ¸…ç†å¤±è´¥ä¸å½±å“åº”ç”¨è¿è¡Œ

### é£é™© 5: FingerprintJS æ€§èƒ½å½±å“
**é£é™©**ï¼šæŒ‡çº¹ç”Ÿæˆå¯èƒ½å½±å“åº”ç”¨å¯åŠ¨é€Ÿåº¦
**ç¼“è§£**ï¼š
- å¼‚æ­¥åŠ è½½ FingerprintJS
- ç¼“å­˜æŒ‡çº¹ç»“æœ
- **ğŸ”¥ å·²å®æ–½**ï¼šä½¿ç”¨ `isAuthChecking` çŠ¶æ€æ˜¾ç¤ºå…¨å± Loadingï¼Œé¿å…é—ªçƒ

### é£é™© 6: è®¿å®¢æ•°æ®å®‰å…¨
**é£é™©**ï¼šè®¿å®¢ç†è®ºä¸Šå¯ä»¥é€šè¿‡ä¿®æ”¹å‰ç«¯ä»£ç æŸ¥çœ‹å…¶ä»–è®¿å®¢æ•°æ®
**ç¼“è§£**ï¼š
- è®¿å®¢æ•°æ® 1 å¤©åè‡ªåŠ¨åˆ é™¤ï¼Œæ— é•¿æœŸä»·å€¼
- è®¿å®¢äº‹ä»¶ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯
- æˆæœ¬å’Œé£é™©éƒ½æä½
- ç®¡ç†å‘˜æ•°æ®é€šè¿‡ä¸¥æ ¼çš„ RLS ç­–ç•¥ä¿æŠ¤

### é£é™© 7: æ—¶åŒºæ··ä¹±
**é£é™©**ï¼šè®¿å®¢åœ¨ä¸åŒæ—¶åŒºåˆ›å»ºäº‹ä»¶ï¼Œæ˜¾ç¤ºæ—¶é—´ä¸ä¸€è‡´
**ç¼“è§£**ï¼š
- **ğŸ”¥ å·²å®æ–½**ï¼šç»Ÿä¸€ä½¿ç”¨ UTC æ—¶é—´æ ‡å‡†
- å‰ç«¯å‘é€ï¼šISO-8601 UTC æ ¼å¼
- æ•°æ®åº“å­˜å‚¨ï¼šTIMESTAMPTZ è‡ªåŠ¨å¤„ç†
- å‰ç«¯æ˜¾ç¤ºï¼šæ ¹æ®æµè§ˆå™¨æ—¶åŒºæœ¬åœ°åŒ–
- Phase 3 å¯é€‰ï¼šè®°å½•è®¿å®¢æ—¶åŒºç”¨äºç›‘æ§åˆ†æ

## éƒ¨ç½²æ¸…å•

### æ•°æ®åº“é…ç½®
- [ ] åœ¨ Supabase Dashboard æ‰§è¡Œè¿ç§»è„šæœ¬
- [ ] éªŒè¯ RLS ç­–ç•¥ç”Ÿæ•ˆ
- [ ] é…ç½® pg_cron å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚æœæ”¯æŒï¼‰
- [ ] æµ‹è¯•å®šæ—¶æ¸…ç†å‡½æ•°

### ç®¡ç†å‘˜è´¦æˆ·
- [ ] åœ¨ Supabase Auth åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·
- [ ] è®°å½•ç®¡ç†å‘˜é‚®ç®±å’Œå¯†ç 
- [ ] æµ‹è¯•ç™»å½•æµç¨‹

### ç¯å¢ƒå˜é‡
- [ ] ç¡®è®¤ VITE_SUPABASE_URL æ­£ç¡®
- [ ] ç¡®è®¤ VITE_SUPABASE_ANON_KEY æ­£ç¡®
- [ ] åœ¨ Vercel é…ç½®ç¯å¢ƒå˜é‡

### åŠŸèƒ½éªŒè¯
- [ ] è®¿å®¢æ¨¡å¼ï¼šæŒ‡çº¹ç”Ÿæˆã€é…é¢é™åˆ¶ã€æ•°æ®éš”ç¦»
- [ ] ç®¡ç†å‘˜æ¨¡å¼ï¼šç™»å½•/ç™»å‡ºã€æ— é™åˆ¶ä½¿ç”¨ã€ç›‘æ§é¡µé¢
- [ ] æƒé™åˆ‡æ¢ï¼šæ•°æ®æ¸…ç©ºå’ŒåŠ è½½
- [ ] å®šæ—¶æ¸…ç†ï¼šéªŒè¯è¿‡æœŸæ•°æ®åˆ é™¤

### ç›‘æ§å’Œæ—¥å¿—
- [ ] éªŒè¯ç›‘æ§é¡µé¢æ˜¾ç¤ºæ­£ç¡®æ•°æ®
- [ ] æ£€æŸ¥æ•°æ®åº“æ—¥å¿—è®°å½•
- [ ] æµ‹è¯•é”™è¯¯å¤„ç†å’Œæç¤º

## æœªæ¥ä¼˜åŒ–æ–¹å‘

### Phase 3: å¢å¼ºåŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
1. **IP é™æµ**ï¼šé˜²æ­¢æ¶æ„ç”¨æˆ·é¢‘ç¹åˆ‡æ¢æŒ‡çº¹
2. **åœ°ç†ä½ç½®ç»Ÿè®¡**ï¼šåˆ†æè®¿å®¢æ¥æº
3. **LLM è°ƒç”¨æˆåŠŸç‡**ï¼šç›‘æ§ API è´¨é‡
4. **äº‹ä»¶åˆ›å»ºè¶‹åŠ¿å›¾**ï¼šå¯è§†åŒ–ä½¿ç”¨æ¨¡å¼
5. **ç®¡ç†å‘˜ 2FA**ï¼šå¢å¼ºå®‰å…¨æ€§
6. **è®¿å®¢åé¦ˆæ”¶é›†**ï¼šæ”¹è¿›äº§å“

### æ€§èƒ½ä¼˜åŒ–
1. **ç›‘æ§é¡µé¢åˆ†é¡µ**ï¼šå¤„ç†å¤§é‡è®¿å®¢ä¼šè¯
2. **è™šæ‹Ÿæ»šåŠ¨**ï¼šä¼˜åŒ–è®¿å®¢åˆ—è¡¨æ¸²æŸ“
3. **ç¼“å­˜ç­–ç•¥**ï¼šå‡å°‘æ•°æ®åº“æŸ¥è¯¢
4. **CDN åŠ é€Ÿ**ï¼šä¼˜åŒ– FingerprintJS åŠ è½½

### ç”¨æˆ·ä½“éªŒä¼˜åŒ–
1. **å¼•å¯¼æ•™ç¨‹**ï¼šé¦–æ¬¡è®¿å®¢å¼•å¯¼
2. **é…é¢æé†’**ï¼šæ¥è¿‘ä¸Šé™æ—¶æç¤º
3. **ç™»å½•æ¿€åŠ±**ï¼šå±•ç¤ºç™»å½•åçš„åŠŸèƒ½
4. **åˆ†äº«åŠŸèƒ½**ï¼šè®¿å®¢å¯ä»¥åˆ†äº«è¯•ç”¨ä½“éªŒ
